<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gmail OAuth Callback</title>
</head>
<body>
  <script>
    (() => {
      const messages = {
        en: {
          success: "Authorization completed, you can close this window.",
          failed: "No authorization info received, please go back and try again.",
        },
        "zh-CN": {
          success: "授权完成，可以关闭此窗口。",
          failed: "未获取到授权信息，请返回重试。",
        },
      };

      function getLang() {
        try {
          const saved = localStorage.getItem("uiLanguage");
          if (saved && messages[saved]) return saved;
        } catch (_) {
          /* ignore */
        }
        return "en";
      }

      const lang = getLang();
      document.documentElement.lang = lang;

      function parseHash() {
        const hash = window.location.hash.replace(/^#/, "");
        const params = {};
        if (!hash) return params;
        hash.split("&").forEach((kv) => {
          const [k, v = ""] = kv.split("=");
          params[decodeURIComponent(k)] = decodeURIComponent(v || "");
        });
        return params;
      }

      const data = parseHash();
      data.source = "gmail-oauth";
      try {
        if (window.opener) {
          window.opener.postMessage(data, "*");
        }
      } catch (_) {
        /* ignore */
      }
      document.body.innerHTML = data.access_token
        ? `<p>${messages[lang].success}</p>`
        : `<p>${messages[lang].failed}</p>`;
      setTimeout(() => {
        window.close();
      }, 1200);
    })();
  </script>
</body>
</html>
